/********************************************************************************************
 * Web Resource: Prefijar laboratorio en Solicitud al laboratorio
 * Autor: PowerApps Pro
 ********************************************************************************************/

if (typeof SolicitudForm === "undefined") SolicitudForm = { __namespace: true };

SolicitudForm.Events = {
    OnLoad: function (executionContext) {
        var formContext = executionContext.getFormContext();
        SolicitudForm.Functions.prefijarLaboratorioDesdeCampania(formContext);

        // Establecer fechas por defecto en primer registro (Create)
        try {
            var formType = (formContext.ui && formContext.ui.getFormType) ? formContext.ui.getFormType() : (formContext.data && formContext.data.getFormType ? formContext.data.getFormType() : null);
            if (formType === 1) { // Create
                var fechaSolAttr = formContext.getAttribute("tema_litogl_tp_dat_fecha_solicitud");
                var fechaEstAttr = formContext.getAttribute("tema_litogl_tp_dat_fecha_entrega_estimada");
                if (fechaSolAttr && fechaSolAttr.getValue() === null) {
                    var hoy = new Date();
                    fechaSolAttr.setValue(hoy);
                }
                if (fechaEstAttr && fechaEstAttr.getValue() === null) {
                    var base = (fechaSolAttr && fechaSolAttr.getValue()) ? new Date(fechaSolAttr.getValue()) : new Date();
                    var estimada = new Date(base.getTime());
                    estimada.setDate(estimada.getDate() + 15);
                    fechaEstAttr.setValue(estimada);
                }
            }
        } catch (e) { console.warn("No fue posible establecer fechas por defecto:", e); }

        // Actualizar fecha estimada si cambia fecha de solicitud y no hay estimada establecida
        try {
            var fechaSolAttr2 = formContext.getAttribute("tema_litogl_tp_dat_fecha_solicitud");
            var fechaEstAttr2 = formContext.getAttribute("tema_litogl_tp_dat_fecha_entrega_estimada");
            if (fechaSolAttr2 && fechaSolAttr2.addOnChange && fechaEstAttr2) {
                fechaSolAttr2.addOnChange(function(){
                    try {
                        if (!fechaEstAttr2.getValue()) {
                            var f = fechaSolAttr2.getValue();
                            var base = f ? new Date(f) : new Date();
                            var estimada = new Date(base.getTime());
                            estimada.setDate(estimada.getDate() + 15);
                            fechaEstAttr2.setValue(estimada);
                        }
                    } catch (e) {}
                });
            }
        } catch (e) {}

        var campAttr = formContext.getAttribute("tema_litogl_tp_bu_id_campana");
        if (campAttr && campAttr.addOnChange) {
            campAttr.addOnChange(function () {
                SolicitudForm.Functions.prefijarLaboratorioDesdeCampania(formContext);
            });
        }
    }
};

SolicitudForm.Functions = {
    prefijarLaboratorioDesdeCampania: function (formContext) {
        try {
            var labAttr = formContext.getAttribute("tema_litogl_tp_bu_idlaboratorio");
            var campLookup = formContext.getAttribute("tema_litogl_tp_bu_id_campana");
            if (!campLookup) return;
            var campVal = campLookup.getValue();
            if (!campVal || campVal.length === 0) return;
            var campId = campVal[0].id.replace(/[{}]/g, "");

            if (labAttr && labAttr.getValue()) return; // Respetar si ya est√° seteado

            Xrm.WebApi.retrieveRecord("tema_litogl_tp_campaniasanalitica", campId, "?$expand=tema_litogl_tp_bu_idlaboratorio($select=tema_litogl_tc_laboratorioid,name)").then(function (res) {
                var laboratorio = res["tema_litogl_tp_bu_idlaboratorio"];
                if (!laboratorio || !laboratorio["tema_litogl_tc_laboratorioid"]) return;
                var lookup = [{
                    id: laboratorio["tema_litogl_tc_laboratorioid"],
                    name: laboratorio.name,
                    entityType: "tema_litogl_tc_laboratorio"
                }];
                labAttr.setValue(lookup);
            });
        } catch (e) {
            console.warn("No fue posible prefijar laboratorio en Solicitud:", e);
        }
    }
};